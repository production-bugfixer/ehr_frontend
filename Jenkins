pipeline {
    agent any

    environment {
        PROJECT_NAME = "ehr-frontend"  // Replace with your dist project folder name if different
        DIST_PATH = "/var/lib/jenkins/workspace/ehr-frontend/dist"
        DEPLOY_PATH = "/var/www/angular-3200"
        NGINX_SITE = "/etc/nginx/sites-available/angular-3200"
    }

    stages {
        stage('Build Angular App') {
            steps {
                dir('ehr-frontend') {
                    sh 'npm install'
                    sh 'ng build --configuration production'
                }
            }
        }

        stage('Copy to Nginx Directory') {
            steps {
                script {
                    sh '''
                        sudo mkdir -p ${DEPLOY_PATH}
                        sudo cp -r ${DIST_PATH}/* ${DEPLOY_PATH}/
                        sudo chown -R www-data:www-data ${DEPLOY_PATH}
                        sudo chmod -R 755 ${DEPLOY_PATH}
                    '''
                }
            }
        }

        stage('Setup Nginx for Port 3200') {
            steps {
                script {
                    sh '''
                        cat <<EOF | sudo tee ${NGINX_SITE}
server {
    listen 3200;
    server_name _;

    root ${DEPLOY_PATH};
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}
EOF

                        # Enable site if not already linked
                        if [ ! -f "/etc/nginx/sites-enabled/angular-3200" ]; then
                            sudo ln -s ${NGINX_SITE} /etc/nginx/sites-enabled/angular-3200
                        fi

                        # Check and restart nginx
                        sudo nginx -t && sudo systemctl restart nginx
                    '''
                }
            }
        }

        stage('Allow Port 3200 in Firewall') {
            steps {
                sh '''
                    sudo ufw allow 3200 || true
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Angular app deployed at http://<your-server-ip>:3200"
        }
        failure {
            echo "❌ Deployment failed"
        }
    }
}
