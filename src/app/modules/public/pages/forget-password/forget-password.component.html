<div class="forgot-password-container">
  <div class="card">
    <div class="card-header">
      <h2>{{ 'FORGET_PASSWORD.TITLE' | translate }}</h2>
    </div>

    <div class="card-body">
      <!-- Form: Request OTP -->
      <form *ngIf="!verificationSent" (ngSubmit)="requestOTP()" [formGroup]="forgotPasswordForm">
        <!-- EHR ID (Email) -->
        <div class="form-group">
          <label for="ehrId">{{ 'FORGET_PASSWORD.EHR_ID' | translate }}</label>
          <input id="ehrId" type="email" formControlName="ehrId" class="form-control" 
                 placeholder="{{ 'FORGET_PASSWORD.EHR_ID_PLACEHOLDER' | translate }}">
          <div *ngIf="forgotPasswordForm.controls['ehrId'].invalid && forgotPasswordForm.controls['ehrId'].touched" 
               class="error-message">
            <span *ngIf="forgotPasswordForm.controls['ehrId'].errors?.['required']">
              {{ 'FORGET_PASSWORD.EHR_ID_REQUIRED' | translate }}
            </span>
            <span *ngIf="forgotPasswordForm.controls['ehrId'].errors?.['email']">
              {{ 'FORGET_PASSWORD.EHR_ID_INVALID' | translate }}
            </span>
          </div>
        </div>

        <!-- Verification Method Toggle -->
        <div class="form-group">
          <label>{{ 'FORGET_PASSWORD.VERIFICATION_METHOD' | translate }}</label>
          <div class="toggle-group">
            <button type="button" 
                    [class.active]="verificationMethod === 'email'"
                    (click)="onVerificationMethodChange('email')">
              {{ 'FORGET_PASSWORD.EMAIL' | translate }}
            </button>
            <button type="button" 
                    [class.active]="verificationMethod === 'phone'"
                    (click)="onVerificationMethodChange('phone')">
              {{ 'FORGET_PASSWORD.PHONE' | translate }}
            </button>
          </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary" [disabled]="loading || forgotPasswordForm.invalid">
          <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          {{ 'FORGET_PASSWORD.SEND_OTP' | translate }}
        </button>

        <!-- Show Request ID (after OTP request success) -->
        <div *ngIf="requestId" class="alert alert-info mt-3">
          {{ 'FORGET_PASSWORD.REQUEST_ID' | translate }}: {{ requestId }}
        </div>
      </form>

      <!-- Form: OTP and Password Reset -->
      <form *ngIf="showResetFields" (ngSubmit)="resetPassword()" [formGroup]="forgotPasswordForm">
        <div class="form-group" *ngIf="requestId">
            {{"FORGET_PASSWORD.REQUEST_ID"|translate}}{{":"+requestId}}
          <label for="otp">{{ 'FORGET_PASSWORD.OTP' | translate }}</label>
          <input id="otp" type="text" formControlName="otp" class="form-control" 
                 placeholder="{{ 'FORGET_PASSWORD.OTP_PLACEHOLDER' | translate }}">
          <div *ngIf="forgotPasswordForm.controls['otp'].invalid && forgotPasswordForm.controls['otp'].touched" 
               class="error-message">
            {{ 'FORGET_PASSWORD.OTP_REQUIRED' | translate }}
          </div>
        </div>

        <div class="form-group">
          <label for="newPassword">{{ 'FORGET_PASSWORD.NEW_PASSWORD' | translate }}</label>
          <input id="newPassword" type="password" formControlName="newPassword" class="form-control" 
                 placeholder="{{ 'FORGET_PASSWORD.NEW_PASSWORD_PLACEHOLDER' | translate }}">
          <div *ngIf="forgotPasswordForm.controls['newPassword'].invalid && forgotPasswordForm.controls['newPassword'].touched" 
               class="error-message">
            <span *ngIf="forgotPasswordForm.controls['newPassword'].errors?.['required']">
              {{ 'FORGET_PASSWORD.PASSWORD_REQUIRED' | translate }}
            </span>
            <span *ngIf="forgotPasswordForm.controls['newPassword'].errors?.['minlength']">
              {{ 'FORGET_PASSWORD.PASSWORD_MIN_LENGTH' | translate }}
            </span>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">{{ 'FORGET_PASSWORD.CONFIRM_PASSWORD' | translate }}</label>
          <input id="confirmPassword" type="password" formControlName="confirmPassword" class="form-control" 
                 placeholder="{{ 'FORGET_PASSWORD.CONFIRM_PASSWORD_PLACEHOLDER' | translate }}">
          <div *ngIf="forgotPasswordForm.controls['confirmPassword'].invalid && forgotPasswordForm.controls['confirmPassword'].touched" 
               class="error-message">
            {{ 'FORGET_PASSWORD.CONFIRM_PASSWORD_REQUIRED' | translate }}
          </div>
          <div *ngIf="forgotPasswordForm.errors?.mismatch" class="error-message">
            {{ 'FORGET_PASSWORD.PASSWORDS_MISMATCH' | translate }}
          </div>
        </div>

        <button type="submit" class="btn btn-primary" [disabled]="loading || forgotPasswordForm.invalid">
          <span *ngIf="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          {{ 'FORGET_PASSWORD.RESET_PASSWORD' | translate }}
        </button>
      </form>

      <!-- Error Message -->
      <div *ngIf="errorMessage" class="alert alert-danger mt-3">
        {{ errorMessage }}
      </div>
    </div>
  </div>
</div>
